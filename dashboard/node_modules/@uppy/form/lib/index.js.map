{"version":3,"sources":["index.js"],"names":["BasePlugin","findDOMElement","toArray","getFormData","packageJson","Form","constructor","uppy","opts","type","id","title","defaultOptions","target","resultName","getMetaFromForm","addResultToForm","submitOnSuccess","triggerUploadOnSubmit","handleFormSubmit","bind","handleUploadStart","handleSuccess","result","form","submit","ev","preventDefault","elements","disabledByUppy","forEach","el","isButton","tagName","disabled","push","upload","then","button","err","Promise","reject","catch","log","stack","message","resultInput","querySelector","updatedResult","JSON","parse","value","Array","isArray","stringify","document","createElement","name","appendChild","formMeta","setMeta","install","nodeName","addEventListener","on","uninstall","removeEventListener","off","VERSION","version"],"mappings":"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","sourcesContent":["import BasePlugin from '@uppy/core/lib/BasePlugin'\nimport findDOMElement from '@uppy/utils/lib/findDOMElement'\nimport toArray from '@uppy/utils/lib/toArray'\n\nimport getFormData from 'get-form-data'\n\nimport packageJson from '../package.json'\n\n/**\n * Form\n */\nexport default class Form extends BasePlugin {\n  static VERSION = packageJson.version\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'acquirer'\n    this.id = this.opts.id || 'Form'\n    this.title = 'Form'\n\n    // set default options\n    const defaultOptions = {\n      target: null,\n      resultName: 'uppyResult',\n      getMetaFromForm: true,\n      addResultToForm: true,\n      submitOnSuccess: false,\n      triggerUploadOnSubmit: false,\n    }\n\n    // merge default options with the ones set by user\n    this.opts = { ...defaultOptions, ...opts }\n\n    this.handleFormSubmit = this.handleFormSubmit.bind(this)\n    this.handleUploadStart = this.handleUploadStart.bind(this)\n    this.handleSuccess = this.handleSuccess.bind(this)\n    this.addResultToForm = this.addResultToForm.bind(this)\n    this.getMetaFromForm = this.getMetaFromForm.bind(this)\n  }\n\n  handleUploadStart () {\n    if (this.opts.getMetaFromForm) {\n      this.getMetaFromForm()\n    }\n  }\n\n  handleSuccess (result) {\n    if (this.opts.addResultToForm) {\n      this.addResultToForm(result)\n    }\n\n    if (this.opts.submitOnSuccess) {\n      this.form.submit()\n    }\n  }\n\n  handleFormSubmit (ev) {\n    if (this.opts.triggerUploadOnSubmit) {\n      ev.preventDefault()\n      const elements = toArray(ev.target.elements)\n      const disabledByUppy = []\n      elements.forEach((el) => {\n        const isButton = el.tagName === 'BUTTON' || (el.tagName === 'INPUT' && el.type === 'submit')\n        if (isButton && !el.disabled) {\n          el.disabled = true // eslint-disable-line no-param-reassign\n          disabledByUppy.push(el)\n        }\n      })\n      this.uppy.upload().then(() => {\n        disabledByUppy.forEach((button) => {\n          button.disabled = false // eslint-disable-line no-param-reassign\n        })\n      }, (err) => {\n        disabledByUppy.forEach((button) => {\n          button.disabled = false // eslint-disable-line no-param-reassign\n        })\n        return Promise.reject(err)\n      }).catch((err) => {\n        this.uppy.log(err.stack || err.message || err)\n      })\n    }\n  }\n\n  addResultToForm (result) {\n    this.uppy.log('[Form] Adding result to the original form:')\n    this.uppy.log(result)\n\n    let resultInput = this.form.querySelector(`[name=\"${this.opts.resultName}\"]`)\n    if (resultInput) {\n      // Append new result to the previous result array.\n      // If the previous result is empty, or not an array,\n      // set it to an empty array.\n      let updatedResult\n      try {\n        updatedResult = JSON.parse(resultInput.value)\n      } catch (err) {\n        // Nothing, since we check for array below anyway\n      }\n\n      if (!Array.isArray(updatedResult)) {\n        updatedResult = []\n      }\n      updatedResult.push(result)\n      resultInput.value = JSON.stringify(updatedResult)\n      return\n    }\n\n    resultInput = document.createElement('input')\n    resultInput.name = this.opts.resultName\n    resultInput.type = 'hidden'\n    resultInput.value = JSON.stringify([result])\n\n    this.form.appendChild(resultInput)\n  }\n\n  getMetaFromForm () {\n    const formMeta = getFormData(this.form)\n    // We want to exclude meta the the Form plugin itself has added\n    // See https://github.com/transloadit/uppy/issues/1637\n    delete formMeta[this.opts.resultName]\n    this.uppy.setMeta(formMeta)\n  }\n\n  install () {\n    this.form = findDOMElement(this.opts.target)\n    if (!this.form || this.form.nodeName !== 'FORM') {\n      this.uppy.log('Form plugin requires a <form> target element passed in options to operate, none was found', 'error')\n      return\n    }\n\n    this.form.addEventListener('submit', this.handleFormSubmit)\n    this.uppy.on('upload', this.handleUploadStart)\n    this.uppy.on('complete', this.handleSuccess)\n  }\n\n  uninstall () {\n    this.form.removeEventListener('submit', this.handleFormSubmit)\n    this.uppy.off('upload', this.handleUploadStart)\n    this.uppy.off('complete', this.handleSuccess)\n  }\n}\n"]}