{"version":3,"sources":["Assembly.js"],"names":["Emitter","has","NetworkError","fetchWithNetworkError","parseUrl","socketIo","requireSocketIo","require","ASSEMBLY_UPLOADING","ASSEMBLY_EXECUTING","ASSEMBLY_COMPLETED","statusOrder","isStatus","status","test","indexOf","TransloaditAssembly","constructor","assembly","rateLimitedQueue","socket","pollInterval","closed","wrapPromiseFunction","connect","update","diff","updateStatus","next","close","disconnect","clearInterval","emit","parsed","websocket_url","origin","transports","path","pathname","on","id","assembly_id","file","uploads","push","stepName","result","results","err","Object","assign","Error","message","setInterval","connected","isPaused","response","assembly_ssl_url","rateLimit","ok","statusText","json","prev","prevStatus","nextStatus","error","nowExecuting","keys","filter","upload","forEach","nextResults","prevResults","n","some","p","undefined"],"mappings":"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","sourcesContent":["import Emitter from 'component-emitter'\nimport has from '@uppy/utils/lib/hasProperty'\nimport NetworkError from '@uppy/utils/lib/NetworkError'\nimport fetchWithNetworkError from '@uppy/utils/lib/fetchWithNetworkError'\nimport parseUrl from './parseUrl.js'\n\n// We used to lazy load socket.io to avoid a console error\n// in IE 10 when the Transloadit plugin is not used.\n// (The console.error call comes from `buffer`. I\n// think we actually don't use that part of socket.io\n// at all…)\n// TODO: remove this hack in the next release.\nlet socketIo\nfunction requireSocketIo () {\n  // eslint-disable-next-line no-return-assign, no-restricted-globals, global-require, no-undef\n  return socketIo ??= require('socket.io-client')\n}\n\nconst ASSEMBLY_UPLOADING = 'ASSEMBLY_UPLOADING'\nconst ASSEMBLY_EXECUTING = 'ASSEMBLY_EXECUTING'\nconst ASSEMBLY_COMPLETED = 'ASSEMBLY_COMPLETED'\n\nconst statusOrder = [\n  ASSEMBLY_UPLOADING,\n  ASSEMBLY_EXECUTING,\n  ASSEMBLY_COMPLETED,\n]\n\n/**\n * Check that an assembly status is equal to or larger than some desired status.\n * It checks for things that are larger so that a comparison like this works,\n * when the old assembly status is UPLOADING but the new is FINISHED:\n *\n * !isStatus(oldStatus, ASSEMBLY_EXECUTING) && isStatus(newState, ASSEMBLY_EXECUTING)\n *\n * …so that we can emit the 'executing' event even if the execution step was so\n * fast that we missed it.\n */\nfunction isStatus (status, test) {\n  return statusOrder.indexOf(status) >= statusOrder.indexOf(test)\n}\n\nclass TransloaditAssembly extends Emitter {\n  #rateLimitedQueue\n\n  #fetchWithNetworkError\n\n  #previousFetchStatusStillPending = false\n\n  constructor (assembly, rateLimitedQueue) {\n    super()\n\n    // The current assembly status.\n    this.status = assembly\n    // The socket.io connection.\n    this.socket = null\n    // The interval timer for full status updates.\n    this.pollInterval = null\n    // Whether this assembly has been closed (finished or errored)\n    this.closed = false\n\n    this.#rateLimitedQueue = rateLimitedQueue\n    this.#fetchWithNetworkError = rateLimitedQueue.wrapPromiseFunction(fetchWithNetworkError)\n  }\n\n  connect () {\n    this.#connectSocket()\n    this.#beginPolling()\n  }\n\n  #onFinished () {\n    this.emit('finished')\n    this.close()\n  }\n\n  #connectSocket () {\n    const parsed = parseUrl(this.status.websocket_url)\n    const socket = requireSocketIo().connect(parsed.origin, {\n      transports: ['websocket'],\n      path: parsed.pathname,\n    })\n\n    socket.on('connect', () => {\n      socket.emit('assembly_connect', {\n        id: this.status.assembly_id,\n      })\n\n      this.emit('connect')\n    })\n\n    socket.on('connect_error', () => {\n      socket.disconnect()\n      this.socket = null\n    })\n\n    socket.on('assembly_finished', () => {\n      this.#onFinished()\n    })\n\n    socket.on('assembly_upload_finished', (file) => {\n      this.emit('upload', file)\n      this.status.uploads.push(file)\n    })\n\n    socket.on('assembly_uploading_finished', () => {\n      this.emit('executing')\n    })\n\n    socket.on('assembly_upload_meta_data_extracted', () => {\n      this.emit('metadata')\n      this.#fetchStatus({ diff: false })\n    })\n\n    socket.on('assembly_result_finished', (stepName, result) => {\n      this.emit('result', stepName, result)\n      if (!this.status.results[stepName]) {\n        this.status.results[stepName] = []\n      }\n      this.status.results[stepName].push(result)\n    })\n\n    socket.on('assembly_error', (err) => {\n      this.#onError(err)\n      // Refetch for updated status code\n      this.#fetchStatus({ diff: false })\n    })\n\n    this.socket = socket\n  }\n\n  #onError (err) {\n    this.emit('error', Object.assign(new Error(err.message), err))\n    this.close()\n  }\n\n  /**\n   * Begin polling for assembly status changes. This sends a request to the\n   * assembly status endpoint every so often, if the socket is not connected.\n   * If the socket connection fails or takes a long time, we won't miss any\n   * events.\n   */\n  #beginPolling () {\n    this.pollInterval = setInterval(() => {\n      if (!this.socket || !this.socket.connected) {\n        this.#fetchStatus()\n      }\n    }, 2000)\n  }\n\n  /**\n   * Reload assembly status. Useful if the socket doesn't work.\n   *\n   * Pass `diff: false` to avoid emitting diff events, instead only emitting\n   * 'status'.\n   */\n  async #fetchStatus ({ diff = true } = {}) {\n    if (this.closed || this.#rateLimitedQueue.isPaused || this.#previousFetchStatusStillPending) return\n\n    try {\n      this.#previousFetchStatusStillPending = true\n      const response = await this.#fetchWithNetworkError(this.status.assembly_ssl_url)\n      this.#previousFetchStatusStillPending = false\n\n      if (this.closed) return\n\n      if (response.status === 429) {\n        this.#rateLimitedQueue.rateLimit(2_000)\n        return\n      }\n\n      if (!response.ok) {\n        this.#onError(new NetworkError(response.statusText))\n        return\n      }\n\n      const status = await response.json()\n      // Avoid updating if we closed during this request's lifetime.\n      if (this.closed) return\n      this.emit('status', status)\n\n      if (diff) {\n        this.updateStatus(status)\n      } else {\n        this.status = status\n      }\n    } catch (err) {\n      this.#onError(err)\n    }\n  }\n\n  update () {\n    return this.#fetchStatus({ diff: true })\n  }\n\n  /**\n   * Update this assembly's status with a full new object. Events will be\n   * emitted for status changes, new files, and new results.\n   *\n   * @param {object} next The new assembly status object.\n   */\n  updateStatus (next) {\n    this.#diffStatus(this.status, next)\n    this.status = next\n  }\n\n  /**\n   * Diff two assembly statuses, and emit the events necessary to go from `prev`\n   * to `next`.\n   *\n   * @param {object} prev The previous assembly status.\n   * @param {object} next The new assembly status.\n   */\n  #diffStatus (prev, next) {\n    const prevStatus = prev.ok\n    const nextStatus = next.ok\n\n    if (next.error && !prev.error) {\n      return this.#onError(next)\n    }\n\n    // Desired emit order:\n    //  - executing\n    //  - (n × upload)\n    //  - metadata\n    //  - (m × result)\n    //  - finished\n    // The below checks run in this order, that way even if we jump from\n    // UPLOADING straight to FINISHED all the events are emitted as expected.\n\n    const nowExecuting = isStatus(nextStatus, ASSEMBLY_EXECUTING)\n      && !isStatus(prevStatus, ASSEMBLY_EXECUTING)\n    if (nowExecuting) {\n      // Without WebSockets, this is our only way to tell if uploading finished.\n      // Hence, we emit this just before the 'upload's and before the 'metadata'\n      // event for the most intuitive ordering, corresponding to the _usual_\n      // ordering (if not guaranteed) that you'd get on the WebSocket.\n      this.emit('executing')\n    }\n\n    // Find new uploaded files.\n    Object.keys(next.uploads)\n      .filter((upload) => !has(prev.uploads, upload))\n      .forEach((upload) => {\n        this.emit('upload', next.uploads[upload])\n      })\n\n    if (nowExecuting) {\n      this.emit('metadata')\n    }\n\n    // Find new results.\n    Object.keys(next.results).forEach((stepName) => {\n      const nextResults = next.results[stepName]\n      const prevResults = prev.results[stepName]\n\n      nextResults\n        .filter((n) => !prevResults || !prevResults.some((p) => p.id === n.id))\n        .forEach((result) => {\n          this.emit('result', stepName, result)\n        })\n    })\n\n    if (isStatus(nextStatus, ASSEMBLY_COMPLETED)\n        && !isStatus(prevStatus, ASSEMBLY_COMPLETED)) {\n      this.emit('finished')\n    }\n\n    return undefined\n  }\n\n  /**\n   * Stop updating this assembly.\n   */\n  close () {\n    this.closed = true\n    if (this.socket) {\n      this.socket.disconnect()\n      this.socket = null\n    }\n    clearInterval(this.pollInterval)\n    this.pollInterval = null\n  }\n}\n\nexport default TransloaditAssembly\n"]}