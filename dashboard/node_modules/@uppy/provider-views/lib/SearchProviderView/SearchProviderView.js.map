{"version":3,"sources":["SearchProviderView.jsx"],"names":["SearchInput","Browser","LoaderView","Header","CloseWrapper","View","packageJson","SearchProviderView","constructor","plugin","opts","defaultOptions","viewType","showTitles","showFilter","showBreadcrumbs","search","bind","triggerSearchInput","addFile","handleScroll","donePicking","render","setPluginState","isInputMode","files","folders","directories","filterInput","currentSelection","searchTerm","tearDown","clearSelection","query","getPluginState","undefined","sharedHandler","loaderWrapper","provider","res","handleError","event","nextPageQuery","shouldHandleScroll","isHandlingScroll","response","error","promises","map","file","Promise","all","state","viewOptions","didFirstRender","preFirstRender","targetViewOptions","loading","isChecked","toggleCheckbox","filterItems","hasInput","browserProps","done","cancel","cancelPicking","headerComponent","i18n","uppy","title","pluginIcon","icon","uppyFiles","getFiles","validateRestrictions","items","forEach","item","push","searchedFor","VERSION","version"],"mappings":"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","sourcesContent":["import { h } from 'preact'\n\nimport SearchInput from './InputView.jsx'\nimport Browser from '../Browser.jsx'\nimport LoaderView from '../Loader.jsx'\nimport Header from './Header.jsx'\nimport CloseWrapper from '../CloseWrapper.js'\nimport View from '../View.js'\n\nimport packageJson from '../../package.json'\n\n/**\n * Class to easily generate generic views for Provider plugins\n */\nexport default class SearchProviderView extends View {\n  static VERSION = packageJson.version\n\n  /**\n   * @param {object} plugin instance of the plugin\n   * @param {object} opts\n   */\n  constructor (plugin, opts) {\n    super(plugin, opts)\n\n    // set default options\n    const defaultOptions = {\n      viewType: 'grid',\n      showTitles: false,\n      showFilter: false,\n      showBreadcrumbs: false,\n    }\n\n    // merge default options with the ones set by user\n    this.opts = { ...defaultOptions, ...opts }\n\n    // Logic\n    this.search = this.search.bind(this)\n    this.triggerSearchInput = this.triggerSearchInput.bind(this)\n    this.addFile = this.addFile.bind(this)\n    this.handleScroll = this.handleScroll.bind(this)\n    this.donePicking = this.donePicking.bind(this)\n\n    // Visual\n    this.render = this.render.bind(this)\n\n    // Set default state for the plugin\n    this.plugin.setPluginState({\n      isInputMode: true,\n      files: [],\n      folders: [],\n      directories: [],\n      filterInput: '',\n      currentSelection: [],\n      searchTerm: null,\n    })\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  tearDown () {\n    // Nothing.\n  }\n\n  clearSelection () {\n    this.plugin.setPluginState({\n      currentSelection: [],\n      isInputMode: true,\n      files: [],\n      searchTerm: null,\n    })\n  }\n\n  #updateFilesAndInputMode (res, files) {\n    this.nextPageQuery = res.nextPageQuery\n    res.items.forEach((item) => { files.push(item) })\n    this.plugin.setPluginState({\n      isInputMode: false,\n      files,\n      searchTerm: res.searchedFor,\n    })\n  }\n\n  search (query) {\n    const { searchTerm } = this.plugin.getPluginState()\n    if (query && query === searchTerm) {\n      // no need to search again as this is the same as the previous search\n      return undefined\n    }\n\n    return this.sharedHandler.loaderWrapper(\n      this.provider.search(query),\n      (res) => {\n        this.#updateFilesAndInputMode(res, [])\n      },\n      this.handleError,\n    )\n  }\n\n  triggerSearchInput () {\n    this.plugin.setPluginState({ isInputMode: true })\n  }\n\n  async handleScroll (event) {\n    const query = this.nextPageQuery || null\n\n    if (this.shouldHandleScroll(event) && query) {\n      this.isHandlingScroll = true\n\n      try {\n        const { files, searchTerm } = this.plugin.getPluginState()\n        const response = await this.provider.search(searchTerm, query)\n\n        this.#updateFilesAndInputMode(response, files)\n      } catch (error) {\n        this.handleError(error)\n      } finally {\n        this.isHandlingScroll = false\n      }\n    }\n  }\n\n  donePicking () {\n    const { currentSelection } = this.plugin.getPluginState()\n    const promises = currentSelection.map((file) => this.addFile(file))\n\n    this.sharedHandler.loaderWrapper(Promise.all(promises), () => {\n      this.clearSelection()\n    }, () => {})\n  }\n\n  render (state, viewOptions = {}) {\n    const { didFirstRender, isInputMode, searchTerm } = this.plugin.getPluginState()\n\n    if (!didFirstRender) {\n      this.preFirstRender()\n    }\n\n    const targetViewOptions = { ...this.opts, ...viewOptions }\n    const { files, folders, filterInput, loading, currentSelection } = this.plugin.getPluginState()\n    const { isChecked, toggleCheckbox, filterItems } = this.sharedHandler\n    const hasInput = filterInput !== ''\n\n    const browserProps = {\n      isChecked,\n      toggleCheckbox,\n      currentSelection,\n      files: hasInput ? filterItems(files) : files,\n      folders: hasInput ? filterItems(folders) : folders,\n      handleScroll: this.handleScroll,\n      done: this.donePicking,\n      cancel: this.cancelPicking,\n      headerComponent: Header({\n        search: this.search,\n        i18n: this.plugin.uppy.i18n,\n        searchTerm,\n      }),\n      title: this.plugin.title,\n      viewType: targetViewOptions.viewType,\n      showTitles: targetViewOptions.showTitles,\n      showFilter: targetViewOptions.showFilter,\n      showBreadcrumbs: targetViewOptions.showBreadcrumbs,\n      pluginIcon: this.plugin.icon,\n      i18n: this.plugin.uppy.i18n,\n      uppyFiles: this.plugin.uppy.getFiles(),\n      validateRestrictions: (...args) => this.plugin.uppy.validateRestrictions(...args),\n    }\n\n    if (loading) {\n      return (\n        <CloseWrapper onUnmount={this.clearSelection}>\n          <LoaderView i18n={this.plugin.uppy.i18n} />\n        </CloseWrapper>\n      )\n    }\n\n    if (isInputMode) {\n      return (\n        <CloseWrapper onUnmount={this.clearSelection}>\n          <SearchInput\n            search={this.search}\n            i18n={this.plugin.uppy.i18n}\n          />\n        </CloseWrapper>\n      )\n    }\n\n    return (\n      <CloseWrapper onUnmount={this.clearSelection}>\n        {/* eslint-disable-next-line react/jsx-props-no-spreading */}\n        <Browser {...browserProps} />\n      </CloseWrapper>\n    )\n  }\n}\n"]}