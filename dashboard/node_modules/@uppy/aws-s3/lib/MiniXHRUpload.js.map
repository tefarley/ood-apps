{"version":3,"sources":["MiniXHRUpload.js"],"names":["emitSocketProgress","getSocketHost","EventTracker","ProgressTimeout","ErrorWithCause","NetworkError","isNetworkError","buildResponseError","xhr","error","err","cause","request","setTypeInBlob","file","dataWithUpdatedType","data","slice","size","meta","type","addMetadata","formData","opts","metaFields","Array","isArray","Object","keys","forEach","item","append","createFormDataUpload","formPost","FormData","name","fieldName","createBareUpload","MiniXHRUpload","constructor","uppy","Client","remote","providerOptions","provider","Provider","RequestClient","client","tus","assign","res","post","url","body","endpoint","fieldname","metadata","fromEntries","map","httpMethod","method","useFormData","headers","token","validateStatus","status","requests","internalRateLimitedQueue","uploaderEvents","create","i18n","wrapPromiseFunction","priority","uploadFile","id","current","total","getFile","Error","isRemote","connectToServerSocket","Promise","resolve","reject","serverToken","host","companionUrl","socket","createSocket","Socket","target","on","progressData","getResponseData","response","responseText","uploadURL","responseUrlFieldName","uploadResp","bytesUploaded","emit","queuedRequest","done","close","remove","errData","resp","getResponseError","message","run","isPaused","send","abort","reason","onRetryRequest","catch","overrides","getState","xhrUpload","eventName","fileID","eventHandler","targetFileID","log","XMLHttpRequest","timer","timeout","seconds","Math","ceil","upload","addEventListener","ev","loaded","progress","lengthComputable","uploader","bytesTotal","open","toUpperCase","withCredentials","Boolean","responseType","header","setRequestHeader","files","undefined","setFileState"],"mappings":"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","sourcesContent":["import { nanoid } from 'nanoid/non-secure'\nimport { Provider, RequestClient, Socket } from '@uppy/companion-client'\nimport emitSocketProgress from '@uppy/utils/lib/emitSocketProgress'\nimport getSocketHost from '@uppy/utils/lib/getSocketHost'\nimport EventTracker from '@uppy/utils/lib/EventTracker'\nimport ProgressTimeout from '@uppy/utils/lib/ProgressTimeout'\nimport ErrorWithCause from '@uppy/utils/lib/ErrorWithCause'\nimport NetworkError from '@uppy/utils/lib/NetworkError'\nimport isNetworkError from '@uppy/utils/lib/isNetworkError'\nimport { internalRateLimitedQueue } from '@uppy/utils/lib/RateLimitedQueue'\n\n// See XHRUpload\nfunction buildResponseError (xhr, error) {\n  if (isNetworkError(xhr)) return new NetworkError(error, xhr)\n\n  const err = new ErrorWithCause('Upload error', { cause: error })\n  err.request = xhr\n  return err\n}\n\n// See XHRUpload\nfunction setTypeInBlob (file) {\n  const dataWithUpdatedType = file.data.slice(0, file.data.size, file.meta.type)\n  return dataWithUpdatedType\n}\n\nfunction addMetadata (formData, meta, opts) {\n  const metaFields = Array.isArray(opts.metaFields)\n    ? opts.metaFields\n    // Send along all fields by default.\n    : Object.keys(meta)\n  metaFields.forEach((item) => {\n    formData.append(item, meta[item])\n  })\n}\n\nfunction createFormDataUpload (file, opts) {\n  const formPost = new FormData()\n\n  addMetadata(formPost, file.meta, opts)\n\n  const dataWithUpdatedType = setTypeInBlob(file)\n\n  if (file.name) {\n    formPost.append(opts.fieldName, dataWithUpdatedType, file.meta.name)\n  } else {\n    formPost.append(opts.fieldName, dataWithUpdatedType)\n  }\n\n  return formPost\n}\n\nconst createBareUpload = file => file.data\n\nexport default class MiniXHRUpload {\n  #queueRequestSocketToken\n\n  constructor (uppy, opts) {\n    this.uppy = uppy\n    this.opts = {\n      validateStatus (status) {\n        return status >= 200 && status < 300\n      },\n      ...opts,\n    }\n\n    this.requests = opts[internalRateLimitedQueue]\n    this.uploaderEvents = Object.create(null)\n    this.i18n = opts.i18n\n\n    this.#queueRequestSocketToken = this.requests.wrapPromiseFunction(this.#requestSocketToken, { priority: -1 })\n  }\n\n  #getOptions (file) {\n    const { uppy } = this\n\n    const overrides = uppy.getState().xhrUpload\n    const opts = {\n      ...this.opts,\n      ...(overrides || {}),\n      ...(file.xhrUpload || {}),\n      headers: {\n        ...this.opts.headers,\n        ...overrides?.headers,\n        ...file.xhrUpload?.headers,\n      },\n    }\n\n    return opts\n  }\n\n  uploadFile (id, current, total) {\n    const file = this.uppy.getFile(id)\n    if (file.error) {\n      throw new Error(file.error)\n    } else if (file.isRemote) {\n      return this.#uploadRemoteFile(file, current, total)\n    }\n    return this.#uploadLocalFile(file, current, total)\n  }\n\n  #addEventHandlerForFile (eventName, fileID, eventHandler) {\n    this.uploaderEvents[fileID].on(eventName, (targetFileID) => {\n      if (fileID === targetFileID) eventHandler()\n    })\n  }\n\n  #addEventHandlerIfFileStillExists (eventName, fileID, eventHandler) {\n    this.uploaderEvents[fileID].on(eventName, (...args) => {\n      if (this.uppy.getFile(fileID)) eventHandler(...args)\n    })\n  }\n\n  #uploadLocalFile (file, current, total) {\n    const opts = this.#getOptions(file)\n\n    this.uppy.log(`uploading ${current} of ${total}`)\n    return new Promise((resolve, reject) => {\n      // This is done in index.js in the S3 plugin.\n      // this.uppy.emit('upload-started', file)\n\n      const data = opts.formData\n        ? createFormDataUpload(file, opts)\n        : createBareUpload(file, opts)\n\n      const xhr = new XMLHttpRequest()\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      const timer = new ProgressTimeout(opts.timeout, () => {\n        xhr.abort()\n        // eslint-disable-next-line no-use-before-define\n        queuedRequest.done()\n        const error = new Error(this.i18n('timedOut', { seconds: Math.ceil(opts.timeout / 1000) }))\n        this.uppy.emit('upload-error', file, error)\n        reject(error)\n      })\n\n      const id = nanoid()\n\n      xhr.upload.addEventListener('loadstart', () => {\n        this.uppy.log(`[AwsS3/XHRUpload] ${id} started`)\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        this.uppy.log(`[AwsS3/XHRUpload] ${id} progress: ${ev.loaded} / ${ev.total}`)\n        // Begin checking for timeouts when progress starts, instead of loading,\n        // to avoid timing out requests on browser concurrency queue\n        timer.progress()\n\n        if (ev.lengthComputable) {\n          this.uppy.emit('upload-progress', file, {\n            uploader: this,\n            bytesUploaded: ev.loaded,\n            bytesTotal: ev.total,\n          })\n        }\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        this.uppy.log(`[AwsS3/XHRUpload] ${id} finished`)\n        timer.done()\n        // eslint-disable-next-line no-use-before-define\n        queuedRequest.done()\n        if (this.uploaderEvents[file.id]) {\n          this.uploaderEvents[file.id].remove()\n          this.uploaderEvents[file.id] = null\n        }\n\n        if (opts.validateStatus(ev.target.status, xhr.responseText, xhr)) {\n          const body = opts.getResponseData(xhr.responseText, xhr)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const uploadResp = {\n            status: ev.target.status,\n            body,\n            uploadURL,\n          }\n\n          this.uppy.emit('upload-success', file, uploadResp)\n\n          if (uploadURL) {\n            this.uppy.log(`Download ${file.name} from ${uploadURL}`)\n          }\n\n          return resolve(file)\n        }\n        const body = opts.getResponseData(xhr.responseText, xhr)\n        const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n\n        const response = {\n          status: ev.target.status,\n          body,\n        }\n\n        this.uppy.emit('upload-error', file, error, response)\n        return reject(error)\n      })\n\n      xhr.addEventListener('error', () => {\n        this.uppy.log(`[AwsS3/XHRUpload] ${id} errored`)\n        timer.done()\n        // eslint-disable-next-line no-use-before-define\n        queuedRequest.done()\n        if (this.uploaderEvents[file.id]) {\n          this.uploaderEvents[file.id].remove()\n          this.uploaderEvents[file.id] = null\n        }\n\n        const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n        this.uppy.emit('upload-error', file, error)\n        return reject(error)\n      })\n\n      xhr.open(opts.method.toUpperCase(), opts.endpoint, true)\n      // IE10 does not allow setting `withCredentials` and `responseType`\n      // before `open()` is called. Itâ€™s important to set withCredentials\n      // to a boolean, otherwise React Native crashes\n      xhr.withCredentials = Boolean(opts.withCredentials)\n      if (opts.responseType !== '') {\n        xhr.responseType = opts.responseType\n      }\n\n      Object.keys(opts.headers).forEach((header) => {\n        xhr.setRequestHeader(header, opts.headers[header])\n      })\n\n      const queuedRequest = this.requests.run(() => {\n        xhr.send(data)\n        return () => {\n          // eslint-disable-next-line no-use-before-define\n          timer.done()\n          xhr.abort()\n        }\n      }, { priority: 1 })\n\n      this.#addEventHandlerForFile('file-removed', file.id, () => {\n        queuedRequest.abort()\n        reject(new Error('File removed'))\n      })\n\n      this.#addEventHandlerIfFileStillExists('cancel-all', file.id, ({ reason } = {}) => {\n        if (reason === 'user') {\n          queuedRequest.abort()\n        }\n        reject(new Error('Upload cancelled'))\n      })\n    })\n  }\n\n  #requestSocketToken = async (file) => {\n    const opts = this.#getOptions(file)\n    const Client = file.remote.providerOptions.provider ? Provider : RequestClient\n    const client = new Client(this.uppy, file.remote.providerOptions)\n    const metaFields = Array.isArray(opts.metaFields)\n      ? opts.metaFields\n      // Send along all fields by default.\n      : Object.keys(file.meta)\n\n    if (file.tus) {\n      // Install file-specific upload overrides.\n      Object.assign(opts, file.tus)\n    }\n\n    const res = await client.post(file.remote.url, {\n      ...file.remote.body,\n      endpoint: opts.endpoint,\n      size: file.data.size,\n      fieldname: opts.fieldName,\n      metadata: Object.fromEntries(metaFields.map(name => [name, file.meta[name]])),\n      httpMethod: opts.method,\n      useFormData: opts.formData,\n      headers: opts.headers,\n    })\n    return res.token\n  }\n\n  async #uploadRemoteFile (file) {\n    // TODO: we could rewrite this to use server-sent events instead of creating WebSockets.\n    try {\n      if (file.serverToken) {\n        return this.connectToServerSocket(file)\n      }\n      const serverToken = await this.#queueRequestSocketToken(file)\n\n      if (!this.uppy.getState().files[file.id]) return undefined\n\n      this.uppy.setFileState(file.id, { serverToken })\n      return this.connectToServerSocket(this.uppy.getFile(file.id))\n    } catch (err) {\n      this.uppy.emit('upload-error', file, err)\n      throw err\n    }\n  }\n\n  connectToServerSocket (file) {\n    return new Promise((resolve, reject) => {\n      const opts = this.#getOptions(file)\n      const token = file.serverToken\n      const host = getSocketHost(file.remote.companionUrl)\n      let socket\n\n      const createSocket = () => {\n        if (socket != null) return\n\n        socket = new Socket({ target: `${host}/api/${token}` })\n\n        socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n        socket.on('success', (data) => {\n          const body = opts.getResponseData(data.response.responseText, data.response)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const uploadResp = {\n            status: data.response.status,\n            body,\n            uploadURL,\n            bytesUploaded: data.bytesUploaded,\n          }\n\n          this.uppy.emit('upload-success', file, uploadResp)\n          queuedRequest.done() // eslint-disable-line no-use-before-define\n          socket.close()\n          if (this.uploaderEvents[file.id]) {\n            this.uploaderEvents[file.id].remove()\n            this.uploaderEvents[file.id] = null\n          }\n          return resolve()\n        })\n\n        socket.on('error', (errData) => {\n          const resp = errData.response\n          const error = resp\n            ? opts.getResponseError(resp.responseText, resp)\n            : new ErrorWithCause(errData.error.message, { cause: errData.error })\n          this.uppy.emit('upload-error', file, error)\n          queuedRequest.done() // eslint-disable-line no-use-before-define\n          if (this.uploaderEvents[file.id]) {\n            this.uploaderEvents[file.id].remove()\n            this.uploaderEvents[file.id] = null\n          }\n          reject(error)\n        })\n      }\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      let queuedRequest = this.requests.run(() => {\n        if (file.isPaused) {\n          socket?.send('pause', {})\n        } else {\n          createSocket()\n        }\n\n        return () => socket.close()\n      })\n\n      this.#addEventHandlerForFile('file-removed', file.id, () => {\n        socket?.send('cancel', {})\n        queuedRequest.abort()\n        resolve(`upload ${file.id} was removed`)\n      })\n\n      this.#addEventHandlerIfFileStillExists('cancel-all', file.id, ({ reason } = {}) => {\n        if (reason === 'user') {\n          socket?.send('cancel', {})\n          queuedRequest.abort()\n        }\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      const onRetryRequest = () => {\n        if (socket == null) {\n          queuedRequest.abort()\n        } else {\n          socket.send('pause', {})\n          queuedRequest.done()\n        }\n        queuedRequest = this.requests.run(() => {\n          if (!file.isPaused) {\n            if (socket == null) {\n              createSocket()\n            } else {\n              socket.send('resume', {})\n            }\n          }\n\n          return () => socket.close()\n        })\n      }\n      this.#addEventHandlerForFile('upload-retry', file.id, onRetryRequest)\n      this.#addEventHandlerIfFileStillExists('retry-all', file.id, onRetryRequest)\n    }).catch((err) => {\n      this.uppy.emit('upload-error', file, err)\n      return Promise.reject(err)\n    })\n  }\n}\n"]}