{"version":3,"sources":["Client.js"],"names":["fetchWithNetworkError","ASSEMBLIES_ENDPOINT","Client","constructor","opts","err","params","errorReporting","type","assembly","assembly_id","instance","url","endpoint","submitError","catch","client","rateLimitedQueue","wrapPromiseFunction","createAssembly","fields","signature","expectedFiles","data","FormData","append","JSON","stringify","Object","keys","forEach","key","URL","service","href","method","headers","body","reserveFile","file","size","encodeURIComponent","assembly_ssl_url","addFile","uploadURL","Promise","reject","Error","uploadUrl","filename","name","fieldname","qs","updateNumberOfFilesInAssembly","num_expected_upload_files","pathname","assembly_updates","cancelAssembly","getAssemblyStatus","message","details","agent","navigator","userAgent","error","args","then","response","status","rateLimit","ok","serverError","statusText","statusCode","endsWith","json","cause"],"mappings":";;;;;;;;MAAOA,qB;;AAEP,MAAMC,mBAAmB,GAAG,aAA5B;AAEA;AACA;AACA;;;;;;;;;;AACe,MAAMC,MAAN,CAAa;AAK1BC,EAAAA,WAAW,CAAEC,KAAF,EAAa;AAAA,QAAXA,KAAW;AAAXA,MAAAA,KAAW,GAAJ,EAAI;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAJb;AAIa;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAmLT,CAACC,GAAD,EAAMC,MAAN,KAAiB;AAC9B,YAAI,KAAKF,IAAL,CAAUG,cAAV,KAA6B,KAAjC,EAAwC;AACtC,gBAAMF,GAAN;AACD;;AAED,cAAMD,IAAI,GAAG;AACXI,UAAAA,IAAI,EAAEF,MAAM,CAACE;AADF,SAAb;;AAGA,YAAIF,MAAM,CAACG,QAAX,EAAqB;AACnBL,UAAAA,IAAI,CAACK,QAAL,GAAgBH,MAAM,CAACG,QAAP,CAAgBC,WAAhC;AACAN,UAAAA,IAAI,CAACO,QAAL,GAAgBL,MAAM,CAACG,QAAP,CAAgBE,QAAhC;AACD;;AACD,YAAIL,MAAM,CAACM,GAAX,EAAgB;AACdR,UAAAA,IAAI,CAACS,QAAL,GAAgBP,MAAM,CAACM,GAAvB;AACD;;AAED,aAAKE,WAAL,CAAiBT,GAAjB,EAAsBD,IAAtB,EAA4BW,KAA5B,CAAkC,MAAM,CACtC;AACD,SAFD;AAIA,cAAMV,GAAN;AACD;AAxMuB;AACtB,SAAKD,IAAL,GAAYA,KAAZ;;AAEA,QAAI,KAAKA,IAAL,CAAUY,MAAV,IAAoB,IAAxB,EAA8B;AAC5B,4DAAc,oBAAd,IAAsC,KAAKZ,IAAL,CAAUY,MAAhD;AACD;;AAED,wFAA8B,KAAKZ,IAAL,CAAUa,gBAAV,CAA2BC,mBAA3B,CAA+ClB,qBAA/C,CAA9B;AACD;AAED;AACF;AACA;AACA;AACA;;;AAoCE;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACEmB,EAAAA,cAAc,OAKX;AAAA,QALa;AACdb,MAAAA,MADc;AAEdc,MAAAA,MAFc;AAGdC,MAAAA,SAHc;AAIdC,MAAAA;AAJc,KAKb;AACD,UAAMC,IAAI,GAAG,IAAIC,QAAJ,EAAb;AACAD,IAAAA,IAAI,CAACE,MAAL,CAAY,QAAZ,EAAsB,OAAOnB,MAAP,KAAkB,QAAlB,GAClBA,MADkB,GAElBoB,IAAI,CAACC,SAAL,CAAerB,MAAf,CAFJ;;AAGA,QAAIe,SAAJ,EAAe;AACbE,MAAAA,IAAI,CAACE,MAAL,CAAY,WAAZ,EAAyBJ,SAAzB;AACD;;AAEDO,IAAAA,MAAM,CAACC,IAAP,CAAYT,MAAZ,EAAoBU,OAApB,CAA6BC,GAAD,IAAS;AACnCR,MAAAA,IAAI,CAACE,MAAL,CAAYM,GAAZ,EAAiBX,MAAM,CAACW,GAAD,CAAvB;AACD,KAFD;AAGAR,IAAAA,IAAI,CAACE,MAAL,CAAY,2BAAZ,EAAyCH,aAAzC;AAEA,UAAMV,GAAG,GAAG,IAAIoB,GAAJ,CAAQ/B,mBAAR,EAA8B,GAAE,KAAKG,IAAL,CAAU6B,OAAQ,EAAlD,EAAqDC,IAAjE;AACA,WAAO,0DAAgBtB,GAAhB,EAAqB;AAC1BuB,MAAAA,MAAM,EAAE,MADkB;AAE1BC,MAAAA,OAAO,8BAAE,IAAF,qBAFmB;AAG1BC,MAAAA,IAAI,EAAEd;AAHoB,KAArB,EAKJR,KALI,CAKGV,GAAD,gCAAS,IAAT,8BAA2BA,GAA3B,EAAgC;AAAEO,MAAAA,GAAF;AAAOJ,MAAAA,IAAI,EAAE;AAAb,KAAhC,CALF,CAAP;AAMD;AAED;AACF;AACA;AACA;AACA;AACA;;;AACE8B,EAAAA,WAAW,CAAE7B,QAAF,EAAY8B,IAAZ,EAAkB;AAC3B,UAAMC,IAAI,GAAGC,kBAAkB,CAACF,IAAI,CAACC,IAAN,CAA/B;AACA,UAAM5B,GAAG,GAAI,GAAEH,QAAQ,CAACiC,gBAAiB,sBAAqBF,IAAK,EAAnE;AACA,WAAO,0DAAgB5B,GAAhB,EAAqB;AAAEuB,MAAAA,MAAM,EAAE,MAAV;AAAkBC,MAAAA,OAAO,8BAAE,IAAF;AAAzB,KAArB,EACJrB,KADI,CACGV,GAAD,gCAAS,IAAT,8BAA2BA,GAA3B,EAAgC;AAAEI,MAAAA,QAAF;AAAY8B,MAAAA,IAAZ;AAAkB3B,MAAAA,GAAlB;AAAuBJ,MAAAA,IAAI,EAAE;AAA7B,KAAhC,CADF,CAAP;AAED;AAED;AACF;AACA;AACA;AACA;AACA;;;AACEmC,EAAAA,OAAO,CAAElC,QAAF,EAAY8B,IAAZ,EAAkB;AACvB,QAAI,CAACA,IAAI,CAACK,SAAV,EAAqB;AACnB,aAAOC,OAAO,CAACC,MAAR,CAAe,IAAIC,KAAJ,CAAU,oCAAV,CAAf,CAAP;AACD;;AACD,UAAMP,IAAI,GAAGC,kBAAkB,CAACF,IAAI,CAACC,IAAN,CAA/B;AACA,UAAMQ,SAAS,GAAGP,kBAAkB,CAACF,IAAI,CAACK,SAAN,CAApC;AACA,UAAMK,QAAQ,GAAGR,kBAAkB,CAACF,IAAI,CAACW,IAAN,CAAnC;AACA,UAAMC,SAAS,GAAG,MAAlB;AAEA,UAAMC,EAAE,GAAI,QAAOZ,IAAK,aAAYS,QAAS,cAAaE,SAAU,UAASH,SAAU,EAAvF;AACA,UAAMpC,GAAG,GAAI,GAAEH,QAAQ,CAACiC,gBAAiB,aAAYU,EAAG,EAAxD;AACA,WAAO,0DAAgBxC,GAAhB,EAAqB;AAAEuB,MAAAA,MAAM,EAAE,MAAV;AAAkBC,MAAAA,OAAO,8BAAE,IAAF;AAAzB,KAArB,EACJrB,KADI,CACGV,GAAD,gCAAS,IAAT,8BAA2BA,GAA3B,EAAgC;AAAEI,MAAAA,QAAF;AAAY8B,MAAAA,IAAZ;AAAkB3B,MAAAA,GAAlB;AAAuBJ,MAAAA,IAAI,EAAE;AAA7B,KAAhC,CADF,CAAP;AAED;AAED;AACF;AACA;AACA;AACA;AACA;;;AACE6C,EAAAA,6BAA6B,CAAE5C,QAAF,EAAY6C,yBAAZ,EAAuC;AAClE,UAAM1C,GAAG,GAAG,IAAIoB,GAAJ,CAAQvB,QAAQ,CAACiC,gBAAjB,CAAZ;AACA9B,IAAAA,GAAG,CAAC2C,QAAJ,GAAe,oBAAf;AACA,UAAMlB,IAAI,GAAGX,IAAI,CAACC,SAAL,CAAe;AAC1B6B,MAAAA,gBAAgB,EAAE,CAAC;AACjB9C,QAAAA,WAAW,EAAED,QAAQ,CAACC,WADL;AAEjB4C,QAAAA;AAFiB,OAAD;AADQ,KAAf,CAAb;AAMA,WAAO,0DAAgB1C,GAAhB,EAAqB;AAAEuB,MAAAA,MAAM,EAAE,MAAV;AAAkBC,MAAAA,OAAO,8BAAE,IAAF,qBAAzB;AAA0CC,MAAAA;AAA1C,KAArB,EACJtB,KADI,CACGV,GAAD,gCAAS,IAAT,8BAA2BA,GAA3B,EAAgC;AAAEO,MAAAA,GAAF;AAAOJ,MAAAA,IAAI,EAAE;AAAb,KAAhC,CADF,CAAP;AAED;AAED;AACF;AACA;AACA;AACA;;;AACEiD,EAAAA,cAAc,CAAEhD,QAAF,EAAY;AACxB,UAAMG,GAAG,GAAGH,QAAQ,CAACiC,gBAArB;AACA,WAAO,0DAAgB9B,GAAhB,EAAqB;AAAEuB,MAAAA,MAAM,EAAE,QAAV;AAAoBC,MAAAA,OAAO,8BAAE,IAAF;AAA3B,KAArB,EACJrB,KADI,CACGV,GAAD,gCAAS,IAAT,8BAA2BA,GAA3B,EAAgC;AAAEO,MAAAA,GAAF;AAAOJ,MAAAA,IAAI,EAAE;AAAb,KAAhC,CADF,CAAP;AAED;AAED;AACF;AACA;AACA;AACA;;;AACEkD,EAAAA,iBAAiB,CAAE9C,GAAF,EAAO;AACtB,WAAO,0DAAgBA,GAAhB,EAAqB;AAAEwB,MAAAA,OAAO,8BAAE,IAAF;AAAT,KAArB,EACJrB,KADI,CACGV,GAAD,gCAAS,IAAT,8BAA2BA,GAA3B,EAAgC;AAAEO,MAAAA,GAAF;AAAOJ,MAAAA,IAAI,EAAE;AAAb,KAAhC,CADF,CAAP;AAED;;AAEDM,EAAAA,WAAW,CAAET,GAAF,SAA8C;AAAA,QAAvC;AAAEQ,MAAAA,QAAF;AAAYF,MAAAA,QAAZ;AAAsBF,MAAAA;AAAtB,KAAuC,sBAAJ,EAAI;AACvD,UAAMkD,OAAO,GAAGtD,GAAG,CAACuD,OAAJ,GACX,GAAEvD,GAAG,CAACsD,OAAQ,KAAItD,GAAG,CAACuD,OAAQ,GADnB,GAEZvD,GAAG,CAACsD,OAFR;AAIA,uCAAO,IAAP,0BAAuB,4CAAvB,EAAqE;AACnExB,MAAAA,MAAM,EAAE,MAD2D;AAEnEE,MAAAA,IAAI,EAAEX,IAAI,CAACC,SAAL,CAAe;AACnBd,QAAAA,QADmB;AAEnBF,QAAAA,QAFmB;AAGnBD,QAAAA,WAAW,EAAED,QAHM;AAInBoD,QAAAA,KAAK,EAAE,OAAOC,SAAP,KAAqB,WAArB,GAAmCA,SAAS,CAACC,SAA7C,GAAyD,EAJ7C;AAKnB/C,QAAAA,MAAM,EAAE,KAAKZ,IAAL,CAAUY,MALC;AAMnBgD,QAAAA,KAAK,EAAEL;AANY,OAAf;AAF6D,KAArE;AAWD;;AAtLyB;;uBAoBL;AAAA,oCAANM,IAAM;AAANA,IAAAA,IAAM;AAAA;;AACnB,SAAO,kFAA4B,GAAGA,IAA/B,EAAqCC,IAArC,CAA0CC,QAAQ,IAAI;AAC3D,QAAIA,QAAQ,CAACC,MAAT,KAAoB,GAAxB,EAA6B;AAC3B,WAAKhE,IAAL,CAAUa,gBAAV,CAA2BoD,SAA3B,CAAqC,IAArC;AACA,yCAAO,IAAP,0BAAuB,GAAGJ,IAA1B;AACD;;AAED,QAAI,CAACE,QAAQ,CAACG,EAAd,EAAkB;AAChB,YAAMC,WAAW,GAAG,IAAIxB,KAAJ,CAAUoB,QAAQ,CAACK,UAAnB,CAApB;AACAD,MAAAA,WAAW,CAACE,UAAZ,GAAyBN,QAAQ,CAACC,MAAlC;AAEA,UAAI,CAAE,GAAEH,IAAI,CAAC,CAAD,CAAI,EAAX,CAAaS,QAAb,CAAsBzE,mBAAtB,CAAL,EAAiD,OAAO4C,OAAO,CAACC,MAAR,CAAeyB,WAAf,CAAP,CAJjC,CAMhB;;AACA,aAAOJ,QAAQ,CAACQ,IAAT,GAAgBT,IAAhB,CAAqBzD,QAAQ,IAAI;AACtC,YAAI,CAACA,QAAQ,CAACuD,KAAd,EAAqB,MAAMO,WAAN;AAErB,cAAMP,KAAK,GAAG,IAAIjB,KAAJ,CAAUtC,QAAQ,CAACuD,KAAnB,CAAd;AACAA,QAAAA,KAAK,CAACJ,OAAN,GAAgBnD,QAAQ,CAACkD,OAAzB;AACAK,QAAAA,KAAK,CAACvD,QAAN,GAAiBA,QAAjB;;AACA,YAAIA,QAAQ,CAACC,WAAb,EAA0B;AACxBsD,UAAAA,KAAK,CAACJ,OAAN,IAAkB,iBAAgBnD,QAAQ,CAACC,WAAY,EAAvD;AACD;;AACD,cAAMsD,KAAN;AACD,OAVM,EAUJ3D,GAAG,IAAI;AACR;AACAA,QAAAA,GAAG,CAACuE,KAAJ,GAAYL,WAAZ;AACA,cAAMlE,GAAN;AACD,OAdM,CAAP;AAeD;;AAED,WAAO8D,QAAQ,CAACQ,IAAT,EAAP;AACD,GA/BM,CAAP;AAgCD;;iBArDkBzE,M","sourcesContent":["import fetchWithNetworkError from '@uppy/utils/lib/fetchWithNetworkError'\n\nconst ASSEMBLIES_ENDPOINT = '/assemblies'\n\n/**\n * A Barebones HTTP API client for Transloadit.\n */\nexport default class Client {\n  #headers = {}\n\n  #fetchWithNetworkError\n\n  constructor (opts = {}) {\n    this.opts = opts\n\n    if (this.opts.client != null) {\n      this.#headers['Transloadit-Client'] = this.opts.client\n    }\n\n    this.#fetchWithNetworkError = this.opts.rateLimitedQueue.wrapPromiseFunction(fetchWithNetworkError)\n  }\n\n  /**\n   * @param  {RequestInfo | URL} input\n   * @param  {RequestInit} init\n   * @returns {Promise<any>}\n   */\n  #fetchJSON (...args) {\n    return this.#fetchWithNetworkError(...args).then(response => {\n      if (response.status === 429) {\n        this.opts.rateLimitedQueue.rateLimit(2_000)\n        return this.#fetchJSON(...args)\n      }\n\n      if (!response.ok) {\n        const serverError = new Error(response.statusText)\n        serverError.statusCode = response.status\n\n        if (!`${args[0]}`.endsWith(ASSEMBLIES_ENDPOINT)) return Promise.reject(serverError)\n\n        // Failed assembly requests should return a more detailed error in JSON.\n        return response.json().then(assembly => {\n          if (!assembly.error) throw serverError\n\n          const error = new Error(assembly.error)\n          error.details = assembly.message\n          error.assembly = assembly\n          if (assembly.assembly_id) {\n            error.details += ` Assembly ID: ${assembly.assembly_id}`\n          }\n          throw error\n        }, err => {\n          // eslint-disable-next-line no-param-reassign\n          err.cause = serverError\n          throw err\n        })\n      }\n\n      return response.json()\n    })\n  }\n\n  /**\n   * Create a new assembly.\n   *\n   * @param {object} options\n   * @param {string|object} options.params\n   * @param {object} options.fields\n   * @param {string} options.signature\n   * @param {number} options.expectedFiles\n   */\n  createAssembly ({\n    params,\n    fields,\n    signature,\n    expectedFiles,\n  }) {\n    const data = new FormData()\n    data.append('params', typeof params === 'string'\n      ? params\n      : JSON.stringify(params))\n    if (signature) {\n      data.append('signature', signature)\n    }\n\n    Object.keys(fields).forEach((key) => {\n      data.append(key, fields[key])\n    })\n    data.append('num_expected_upload_files', expectedFiles)\n\n    const url = new URL(ASSEMBLIES_ENDPOINT, `${this.opts.service}`).href\n    return this.#fetchJSON(url, {\n      method: 'post',\n      headers: this.#headers,\n      body: data,\n    })\n      .catch((err) => this.#reportError(err, { url, type: 'API_ERROR' }))\n  }\n\n  /**\n   * Reserve resources for a file in an Assembly. Then addFile can be used later.\n   *\n   * @param {object} assembly\n   * @param {UppyFile} file\n   */\n  reserveFile (assembly, file) {\n    const size = encodeURIComponent(file.size)\n    const url = `${assembly.assembly_ssl_url}/reserve_file?size=${size}`\n    return this.#fetchJSON(url, { method: 'post', headers: this.#headers })\n      .catch((err) => this.#reportError(err, { assembly, file, url, type: 'API_ERROR' }))\n  }\n\n  /**\n   * Import a remote file to an Assembly.\n   *\n   * @param {object} assembly\n   * @param {UppyFile} file\n   */\n  addFile (assembly, file) {\n    if (!file.uploadURL) {\n      return Promise.reject(new Error('File does not have an `uploadURL`.'))\n    }\n    const size = encodeURIComponent(file.size)\n    const uploadUrl = encodeURIComponent(file.uploadURL)\n    const filename = encodeURIComponent(file.name)\n    const fieldname = 'file'\n\n    const qs = `size=${size}&filename=${filename}&fieldname=${fieldname}&s3Url=${uploadUrl}`\n    const url = `${assembly.assembly_ssl_url}/add_file?${qs}`\n    return this.#fetchJSON(url, { method: 'post', headers: this.#headers })\n      .catch((err) => this.#reportError(err, { assembly, file, url, type: 'API_ERROR' }))\n  }\n\n  /**\n   * Update the number of expected files in an already created assembly.\n   *\n   * @param {object} assembly\n   * @param {number} num_expected_upload_files\n   */\n  updateNumberOfFilesInAssembly (assembly, num_expected_upload_files) {\n    const url = new URL(assembly.assembly_ssl_url)\n    url.pathname = '/update_assemblies'\n    const body = JSON.stringify({\n      assembly_updates: [{\n        assembly_id: assembly.assembly_id,\n        num_expected_upload_files,\n      }],\n    })\n    return this.#fetchJSON(url, { method: 'post', headers: this.#headers, body })\n      .catch((err) => this.#reportError(err, { url, type: 'API_ERROR' }))\n  }\n\n  /**\n   * Cancel a running Assembly.\n   *\n   * @param {object} assembly\n   */\n  cancelAssembly (assembly) {\n    const url = assembly.assembly_ssl_url\n    return this.#fetchJSON(url, { method: 'delete', headers: this.#headers })\n      .catch((err) => this.#reportError(err, { url, type: 'API_ERROR' }))\n  }\n\n  /**\n   * Get the current status for an assembly.\n   *\n   * @param {string} url The status endpoint of the assembly.\n   */\n  getAssemblyStatus (url) {\n    return this.#fetchJSON(url, { headers: this.#headers })\n      .catch((err) => this.#reportError(err, { url, type: 'STATUS_ERROR' }))\n  }\n\n  submitError (err, { endpoint, instance, assembly } = {}) {\n    const message = err.details\n      ? `${err.message} (${err.details})`\n      : err.message\n\n    return this.#fetchJSON('https://transloaditstatus.com/client_error', {\n      method: 'post',\n      body: JSON.stringify({\n        endpoint,\n        instance,\n        assembly_id: assembly,\n        agent: typeof navigator !== 'undefined' ? navigator.userAgent : '',\n        client: this.opts.client,\n        error: message,\n      }),\n    })\n  }\n\n  #reportError = (err, params) => {\n    if (this.opts.errorReporting === false) {\n      throw err\n    }\n\n    const opts = {\n      type: params.type,\n    }\n    if (params.assembly) {\n      opts.assembly = params.assembly.assembly_id\n      opts.instance = params.assembly.instance\n    }\n    if (params.url) {\n      opts.endpoint = params.url\n    }\n\n    this.submitError(err, opts).catch(() => {\n      // not much we can do then is there\n    })\n\n    throw err\n  }\n}\n"]}