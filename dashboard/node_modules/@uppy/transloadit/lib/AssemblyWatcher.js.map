{"version":3,"sources":["AssemblyWatcher.js"],"names":["Emitter","TransloaditAssemblyWatcher","constructor","uppy","assemblyIDs","assembly","assembly_id","log","emit","error","fileID","length","promise","Promise","resolve","reject","id","indexOf","off","on"],"mappings":";;;;;;;;MAAOA,O;AAEP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,MAAMC,0BAAN,SAAyCD,OAAzC,CAAiD;AAW/CE,EAAAA,WAAW,CAAEC,IAAF,EAAQC,WAAR,EAAqB;AAC9B;AAD8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAsBTC,QAAD,IAAc;AAClC,YAAI,6BAAC,IAAD,wBAAgBA,QAAQ,CAACC,WAAzB,CAAJ,EAA2C;AACzC;AACD;;AAED,wDAAWC,GAAX,CAAgB,sDAAqDF,QAAQ,CAACC,WAAY,EAA1F;;AAEA,aAAKE,IAAL,CAAU,mBAAV,EAA+BH,QAAQ,CAACC,WAAxC;;AAEA;AACD;AAhC+B;AAAA;AAAA;AAAA,aAkCXD,QAAD,IAAc;AAChC,YAAI,6BAAC,IAAD,wBAAgBA,QAAQ,CAACC,WAAzB,CAAJ,EAA2C;AACzC;AACD;;AAED;AACD;AAxC+B;AAAA;AAAA;AAAA,aA0Cb,CAACD,QAAD,EAAWI,KAAX,KAAqB;AACtC,YAAI,6BAAC,IAAD,wBAAgBJ,QAAQ,CAACC,WAAzB,CAAJ,EAA2C;AACzC;AACD;;AAED,wDAAWC,GAAX,CAAgB,qDAAoDF,QAAQ,CAACC,WAAY,EAAzF;;AACA,wDAAWC,GAAX,CAAeE,KAAf;;AAEA,aAAKD,IAAL,CAAU,gBAAV,EAA4BH,QAAQ,CAACC,WAArC,EAAkDG,KAAlD;;AAEA;AACD;AArD+B;AAAA;AAAA;AAAA,aAuDf,CAACJ,QAAD,EAAWK,MAAX,EAAmBD,KAAnB,KAA6B;AAC5C,YAAI,6BAAC,IAAD,wBAAgBJ,QAAQ,CAACC,WAAzB,CAAJ,EAA2C;AACzC;AACD,SAH2C,CAK5C;AACA;AACA;AACA;AACA;;;AACA,8EAAsBD,QAAtB,EAAgCI,KAAhC;AACD;AAlE+B;AAG9B,sDAAaN,IAAb;AACA,oEAAoBC,WAApB;AACA,gEAAkBA,WAAW,CAACO,MAA9B;AAEA,SAAKC,OAAL,GAAe,IAAIC,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AAC9C,8DAAgBD,OAAhB;AACA,4DAAeC,MAAf;AACD,KAHc,CAAf;;AAKA;AACD;AAED;AACF;AACA;;;AA5BiD;;oBA6BpCC,E,EAAI;AACb,SAAO,8DAAkBC,OAAlB,CAA0BD,EAA1B,MAAkC,CAAC,CAA1C;AACD;;8BAgDoB;AACnB,+DAAmB,CAAnB;;AACA,MAAI,8DAAoB,CAAxB,EAA2B;AACzB;AACA;;AACA;AACD;AACF;;6BAEmB;AAClB,kDAAWE,GAAX,CAAe,sBAAf,8BAAuC,IAAvC;;AACA,kDAAWA,GAAX,CAAe,6BAAf,8BAA8C,IAA9C;;AACA,kDAAWA,GAAX,CAAe,4BAAf,8BAA6C,IAA7C;;AACA,kDAAWA,GAAX,CAAe,0BAAf,8BAA2C,IAA3C;AACD;;0BAEgB;AACf,kDAAWC,EAAX,CAAc,sBAAd,8BAAsC,IAAtC;;AACA,kDAAWA,EAAX,CAAc,6BAAd,8BAA6C,IAA7C;;AACA,kDAAWA,EAAX,CAAc,4BAAd,8BAA4C,IAA5C;;AACA,kDAAWA,EAAX,CAAc,0BAAd,8BAA0C,IAA1C;AACD;;iBAGYlB,0B","sourcesContent":["import Emitter from 'component-emitter'\n\n/**\n * Track completion of multiple assemblies.\n *\n * Emits 'assembly-complete' when an assembly completes.\n * Emits 'assembly-error' when an assembly fails.\n * Exposes a `.promise` property that resolves when all assemblies have\n * completed (or failed).\n */\nclass TransloaditAssemblyWatcher extends Emitter {\n  #assemblyIDs\n\n  #reject\n\n  #remaining\n\n  #resolve\n\n  #uppy\n\n  constructor (uppy, assemblyIDs) {\n    super()\n\n    this.#uppy = uppy\n    this.#assemblyIDs = assemblyIDs\n    this.#remaining = assemblyIDs.length\n\n    this.promise = new Promise((resolve, reject) => {\n      this.#resolve = resolve\n      this.#reject = reject\n    })\n\n    this.#addListeners()\n  }\n\n  /**\n   * Are we watching this assembly ID?\n   */\n  #watching (id) {\n    return this.#assemblyIDs.indexOf(id) !== -1\n  }\n\n  #onAssemblyComplete = (assembly) => {\n    if (!this.#watching(assembly.assembly_id)) {\n      return\n    }\n\n    this.#uppy.log(`[Transloadit] AssemblyWatcher: Got Assembly finish ${assembly.assembly_id}`)\n\n    this.emit('assembly-complete', assembly.assembly_id)\n\n    this.#checkAllComplete()\n  }\n\n  #onAssemblyCancel = (assembly) => {\n    if (!this.#watching(assembly.assembly_id)) {\n      return\n    }\n\n    this.#checkAllComplete()\n  }\n\n  #onAssemblyError = (assembly, error) => {\n    if (!this.#watching(assembly.assembly_id)) {\n      return\n    }\n\n    this.#uppy.log(`[Transloadit] AssemblyWatcher: Got Assembly error ${assembly.assembly_id}`)\n    this.#uppy.log(error)\n\n    this.emit('assembly-error', assembly.assembly_id, error)\n\n    this.#checkAllComplete()\n  }\n\n  #onImportError = (assembly, fileID, error) => {\n    if (!this.#watching(assembly.assembly_id)) {\n      return\n    }\n\n    // Not sure if we should be doing something when it's just one file failing.\n    // ATM, the only options are 1) ignoring or 2) failing the entire upload.\n    // I think failing the upload is better than silently ignoring.\n    // In the future we should maybe have a way to resolve uploads with some failures,\n    // like returning an object with `{ successful, failed }` uploads.\n    this.#onAssemblyError(assembly, error)\n  }\n\n  #checkAllComplete () {\n    this.#remaining -= 1\n    if (this.#remaining === 0) {\n      // We're done, these listeners can be removed\n      this.#removeListeners()\n      this.#resolve()\n    }\n  }\n\n  #removeListeners () {\n    this.#uppy.off('transloadit:complete', this.#onAssemblyComplete)\n    this.#uppy.off('transloadit:assembly-cancel', this.#onAssemblyCancel)\n    this.#uppy.off('transloadit:assembly-error', this.#onAssemblyError)\n    this.#uppy.off('transloadit:import-error', this.#onImportError)\n  }\n\n  #addListeners () {\n    this.#uppy.on('transloadit:complete', this.#onAssemblyComplete)\n    this.#uppy.on('transloadit:assembly-cancel', this.#onAssemblyCancel)\n    this.#uppy.on('transloadit:assembly-error', this.#onAssemblyError)\n    this.#uppy.on('transloadit:import-error', this.#onImportError)\n  }\n}\n\nexport default TransloaditAssemblyWatcher\n"]}