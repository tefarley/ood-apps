{"version":3,"sources":["IndexedDBStore.js"],"names":["indexedDB","window","webkitIndexedDB","mozIndexedDB","OIndexedDB","msIndexedDB","isSupported","DB_NAME","STORE_NAME","DEFAULT_EXPIRY","DB_VERSION","migrateExpiration","store","request","openCursor","onsuccess","event","cursor","target","result","entry","value","expires","Date","now","update","connect","dbName","open","Promise","resolve","reject","onupgradeneeded","db","transaction","currentTarget","oldVersion","createObjectStore","keyPath","createIndex","unique","objectStore","oncomplete","onerror","waitForRequest","cleanedUp","IndexedDBStore","constructor","opts","storeName","maxFileSize","maxTotalSize","name","createConnection","ready","cleanup","then","key","fileID","list","index","getAll","IDBKeyRange","only","files","forEach","file","data","get","id","getSize","size","continue","Error","put","add","delete","upperBound","close"],"mappings":"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","sourcesContent":["const indexedDB = typeof window !== 'undefined'\n  && (window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.OIndexedDB || window.msIndexedDB)\n\nconst isSupported = !!indexedDB\n\nconst DB_NAME = 'uppy-blobs'\nconst STORE_NAME = 'files' // maybe have a thumbnail store in the future\nconst DEFAULT_EXPIRY = 24 * 60 * 60 * 1000 // 24 hours\nconst DB_VERSION = 3\n\n// Set default `expires` dates on existing stored blobs.\nfunction migrateExpiration (store) {\n  const request = store.openCursor()\n  request.onsuccess = (event) => {\n    const cursor = event.target.result\n    if (!cursor) {\n      return\n    }\n    const entry = cursor.value\n    entry.expires = Date.now() + DEFAULT_EXPIRY\n    cursor.update(entry)\n  }\n}\n\nfunction connect (dbName) {\n  const request = indexedDB.open(dbName, DB_VERSION)\n  return new Promise((resolve, reject) => {\n    request.onupgradeneeded = (event) => {\n      const db = event.target.result\n      const { transaction } = event.currentTarget\n\n      if (event.oldVersion < 2) {\n        // Added in v2: DB structure changed to a single shared object store\n        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' })\n        store.createIndex('store', 'store', { unique: false })\n      }\n\n      if (event.oldVersion < 3) {\n        // Added in v3\n        const store = transaction.objectStore(STORE_NAME)\n        store.createIndex('expires', 'expires', { unique: false })\n\n        migrateExpiration(store)\n      }\n\n      transaction.oncomplete = () => {\n        resolve(db)\n      }\n    }\n    request.onsuccess = (event) => {\n      resolve(event.target.result)\n    }\n    request.onerror = reject\n  })\n}\n\nfunction waitForRequest (request) {\n  return new Promise((resolve, reject) => {\n    request.onsuccess = (event) => {\n      resolve(event.target.result)\n    }\n    request.onerror = reject\n  })\n}\n\nlet cleanedUp = false\nclass IndexedDBStore {\n  constructor (opts) {\n    this.opts = {\n      dbName: DB_NAME,\n      storeName: 'default',\n      expires: DEFAULT_EXPIRY, // 24 hours\n      maxFileSize: 10 * 1024 * 1024, // 10 MB\n      maxTotalSize: 300 * 1024 * 1024, // 300 MB\n      ...opts,\n    }\n\n    this.name = this.opts.storeName\n\n    const createConnection = () => {\n      return connect(this.opts.dbName)\n    }\n\n    if (!cleanedUp) {\n      cleanedUp = true\n      this.ready = IndexedDBStore.cleanup()\n        .then(createConnection, createConnection)\n    } else {\n      this.ready = createConnection()\n    }\n  }\n\n  key (fileID) {\n    return `${this.name}!${fileID}`\n  }\n\n  /**\n   * List all file blobs currently in the store.\n   */\n  list () {\n    return this.ready.then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readonly')\n      const store = transaction.objectStore(STORE_NAME)\n      const request = store.index('store')\n        .getAll(IDBKeyRange.only(this.name))\n      return waitForRequest(request)\n    }).then((files) => {\n      const result = {}\n      files.forEach((file) => {\n        result[file.fileID] = file.data\n      })\n      return result\n    })\n  }\n\n  /**\n   * Get one file blob from the store.\n   */\n  get (fileID) {\n    return this.ready.then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readonly')\n      const request = transaction.objectStore(STORE_NAME)\n        .get(this.key(fileID))\n      return waitForRequest(request)\n    }).then((result) => ({\n      id: result.data.fileID,\n      data: result.data.data,\n    }))\n  }\n\n  /**\n   * Get the total size of all stored files.\n   *\n   * @private\n   */\n  getSize () {\n    return this.ready.then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readonly')\n      const store = transaction.objectStore(STORE_NAME)\n      const request = store.index('store')\n        .openCursor(IDBKeyRange.only(this.name))\n      return new Promise((resolve, reject) => {\n        let size = 0\n        request.onsuccess = (event) => {\n          const cursor = event.target.result\n          if (cursor) {\n            size += cursor.value.data.size\n            cursor.continue()\n          } else {\n            resolve(size)\n          }\n        }\n        request.onerror = () => {\n          reject(new Error('Could not retrieve stored blobs size'))\n        }\n      })\n    })\n  }\n\n  /**\n   * Save a file in the store.\n   */\n  put (file) {\n    if (file.data.size > this.opts.maxFileSize) {\n      return Promise.reject(new Error('File is too big to store.'))\n    }\n    return this.getSize().then((size) => {\n      if (size > this.opts.maxTotalSize) {\n        return Promise.reject(new Error('No space left'))\n      }\n      return this.ready\n    }).then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readwrite')\n      const request = transaction.objectStore(STORE_NAME).add({\n        id: this.key(file.id),\n        fileID: file.id,\n        store: this.name,\n        expires: Date.now() + this.opts.expires,\n        data: file.data,\n      })\n      return waitForRequest(request)\n    })\n  }\n\n  /**\n   * Delete a file blob from the store.\n   */\n  delete (fileID) {\n    return this.ready.then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readwrite')\n      const request = transaction.objectStore(STORE_NAME)\n        .delete(this.key(fileID))\n      return waitForRequest(request)\n    })\n  }\n\n  /**\n   * Delete all stored blobs that have an expiry date that is before Date.now().\n   * This is a static method because it deletes expired blobs from _all_ Uppy instances.\n   */\n  static cleanup () {\n    return connect(DB_NAME).then((db) => {\n      const transaction = db.transaction([STORE_NAME], 'readwrite')\n      const store = transaction.objectStore(STORE_NAME)\n      const request = store.index('expires')\n        .openCursor(IDBKeyRange.upperBound(Date.now()))\n      return new Promise((resolve, reject) => {\n        request.onsuccess = (event) => {\n          const cursor = event.target.result\n          if (cursor) {\n            cursor.delete() // Ignoring return value … it's not terrible if this goes wrong.\n            cursor.continue()\n          } else {\n            resolve(db)\n          }\n        }\n        request.onerror = reject\n      })\n    }).then((db) => {\n      db.close()\n    })\n  }\n}\n\nIndexedDBStore.isSupported = isSupported\n\nexport default IndexedDBStore\n"]}