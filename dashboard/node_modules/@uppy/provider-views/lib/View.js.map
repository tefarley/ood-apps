{"version":3,"sources":["View.js"],"names":["getFileType","isPreviewSupported","generateFileID","SharedHandler","View","constructor","plugin","opts","provider","sharedHandler","isHandlingScroll","preFirstRender","bind","handleError","addFile","clearSelection","cancelPicking","providerFileToId","file","data","name","id","type","mimetype","setPluginState","didFirstRender","onFirstRender","shouldHandleScroll","event","scrollHeight","scrollTop","offsetHeight","target","scrollPosition","currentSelection","dashboard","uppy","getPlugin","hideAllPanels","error","message","i18n","log","toString","isAuthError","info","details","tagFile","source","mimeType","isRemote","meta","body","fileId","remote","companionUrl","url","fileUrl","requestPath","providerOptions","providerName","fileType","preview","thumbnail","author","authorName","String","authorUrl","err","isRestriction"],"mappings":"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","sourcesContent":["import getFileType from '@uppy/utils/lib/getFileType'\nimport isPreviewSupported from '@uppy/utils/lib/isPreviewSupported'\nimport generateFileID from '@uppy/utils/lib/generateFileID'\n\n// TODO: now that we have a shared `View` class,\n// `SharedHandler` could be cleaned up and moved into here\nimport SharedHandler from './SharedHandler.js'\n\nexport default class View {\n  constructor (plugin, opts) {\n    this.plugin = plugin\n    this.provider = opts.provider\n    this.sharedHandler = new SharedHandler(plugin)\n\n    this.isHandlingScroll = false\n\n    this.preFirstRender = this.preFirstRender.bind(this)\n    this.handleError = this.handleError.bind(this)\n    this.addFile = this.addFile.bind(this)\n    this.clearSelection = this.clearSelection.bind(this)\n    this.cancelPicking = this.cancelPicking.bind(this)\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  providerFileToId (file) {\n    return generateFileID({\n      data: file,\n      name: file.name || file.id,\n      type: file.mimetype,\n    })\n  }\n\n  preFirstRender () {\n    this.plugin.setPluginState({ didFirstRender: true })\n    this.plugin.onFirstRender()\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  shouldHandleScroll (event) {\n    const { scrollHeight, scrollTop, offsetHeight } = event.target\n    const scrollPosition = scrollHeight - (scrollTop + offsetHeight)\n\n    return scrollPosition < 50 && !this.isHandlingScroll\n  }\n\n  clearSelection () {\n    this.plugin.setPluginState({ currentSelection: [] })\n  }\n\n  cancelPicking () {\n    this.clearSelection()\n\n    const dashboard = this.plugin.uppy.getPlugin('Dashboard')\n\n    if (dashboard) {\n      dashboard.hideAllPanels()\n    }\n  }\n\n  handleError (error) {\n    const { uppy } = this.plugin\n    const message = uppy.i18n('companionError')\n\n    uppy.log(error.toString())\n\n    if (error.isAuthError) {\n      return\n    }\n\n    uppy.info({ message, details: error.toString() }, 'error', 5000)\n  }\n\n  addFile (file) {\n    const tagFile = {\n      id: this.providerFileToId(file),\n      source: this.plugin.id,\n      data: file,\n      name: file.name || file.id,\n      type: file.mimeType,\n      isRemote: true,\n      meta: {},\n      body: {\n        fileId: file.id,\n      },\n      remote: {\n        companionUrl: this.plugin.opts.companionUrl,\n        url: `${this.provider.fileUrl(file.requestPath)}`,\n        body: {\n          fileId: file.id,\n        },\n        providerOptions: this.provider.opts,\n        providerName: this.provider.name,\n      },\n    }\n\n    const fileType = getFileType(tagFile)\n\n    // TODO Should we just always use the thumbnail URL if it exists?\n    if (fileType && isPreviewSupported(fileType)) {\n      tagFile.preview = file.thumbnail\n    }\n\n    if (file.author) {\n      if (file.author.name != null) tagFile.meta.authorName = String(file.author.name)\n      if (file.author.url) tagFile.meta.authorUrl = file.author.url\n    }\n\n    this.plugin.uppy.log('Adding remote file')\n\n    try {\n      this.plugin.uppy.addFile(tagFile)\n      return true\n    } catch (err) {\n      if (!err.isRestriction) {\n        this.plugin.uppy.log(err)\n      }\n      return false\n    }\n  }\n}\n"]}